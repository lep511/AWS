AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: CloudFront origin security with Cognito, AWS WAF and AWS Secrets Manager
Parameters:
  ApiGatewayURL:
    Type: String
    Description: Your API's invoke URL WITH stage name
  HeaderName:
    Default: X-Origin-Verify
    Description: Header name for secret string.
    Type: String
  WAFRulePriority:
    Default: '0'
    Description: Rule number to use for regional WAF web ACL. 0 is recommended.
    Type: Number
Resources:
  WAUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName:
        Fn::Join:
        - ''
        - - WAUserPool-
          - Fn::Select:
            - 2
            - Fn::Split:
              - /
              - Ref: AWS::StackId
      AutoVerifiedAttributes:
      - email
      UsernameAttributes:
      - email
      Schema:
      - AttributeDataType: String
        Name: email
        Required: true
      VerificationMessageTemplate:
        DefaultEmailOption: CONFIRM_WITH_LINK
  WAUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName:
        Fn::Join:
        - ''
        - - WAUserPoolClient-
          - Fn::Select:
            - 2
            - Fn::Split:
              - /
              - Ref: AWS::StackId
      GenerateSecret: true
      UserPoolId:
        Ref: WAUserPool
      AllowedOAuthFlows:
      - code
      - implicit
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthScopes:
      - email
      - openid
      - aws.cognito.signin.user.admin
      CallbackURLs:
      - https://example.com/callback
      DefaultRedirectURI: https://example.com/callback
      ExplicitAuthFlows:
      - ALLOW_ADMIN_USER_PASSWORD_AUTH
      - ALLOW_CUSTOM_AUTH
      - ALLOW_USER_SRP_AUTH
      - ALLOW_REFRESH_TOKEN_AUTH
      LogoutURLs:
      - https://example.com/signout
      SupportedIdentityProviders:
      - COGNITO
      PreventUserExistenceErrors: ENABLED
  WACognitoUserPoUserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      UserPoolId:
        Ref: WAUserPool
      Domain:
        Fn::Join:
        - ''
        - - walab-
          - Fn::Select:
            - 2
            - Fn::Split:
              - /
              - Ref: AWS::StackId
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Comment: CDN with Origin Custom Header generated by Secrets Manager
        WebACLId:
          Fn::GetAtt:
          - wafACLG
          - Arn
        Origins:
        - DomainName:
            Fn::Select:
            - 2
            - Fn::Split:
              - /
              - Ref: ApiGatewayURL
          OriginPath:
            Fn::Sub:
            - /${stage}
            - stage:
                Fn::Select:
                - 3
                - Fn::Split:
                  - /
                  - Ref: ApiGatewayURL
          Id:
            Fn::Sub:
            - Custom-${apiurl}
            - apiurl:
                Fn::Select:
                - 2
                - Fn::Split:
                  - /
                  - Ref: ApiGatewayURL
          CustomOriginConfig:
            HTTPPort: '80'
            HTTPSPort: '443'
            OriginSSLProtocols:
            - TLSv1.2
            OriginProtocolPolicy: https-only
        Enabled: true
        HttpVersion: http2
        DefaultCacheBehavior:
          AllowedMethods:
          - GET
          - HEAD
          SmoothStreaming: false
          TargetOriginId:
            Fn::Sub:
            - Custom-${apiurl}
            - apiurl:
                Fn::Select:
                - 2
                - Fn::Split:
                  - /
                  - Ref: ApiGatewayURL
          ForwardedValues:
            QueryString: true
          ViewerProtocolPolicy: redirect-to-https
  OriginVerifyHeader:
    Type: AWS::SecretsManager::Secret
    Description: Randomly generated header
    Properties:
      Description: Origin Custom Header value for CloudFront
      GenerateSecretString:
        SecretStringTemplate:
          Fn::Sub: '{"HEADERVALUE": "RandomHeader"}'
        GenerateStringKey: HEADERVALUE
        ExcludePunctuation: true
  RotateFunctionInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Ref: OriginSecretRotateFunction
      Action: lambda:InvokeFunction
      Principal: secretsmanager.amazonaws.com
  OriginVerifyRotateSchedule:
    Type: AWS::SecretsManager::RotationSchedule
    Properties:
      RotationLambdaARN:
        Fn::GetAtt:
        - OriginSecretRotateFunction
        - Arn
      RotationRules:
        AutomaticallyAfterDays: 7
      SecretId:
        Ref: OriginVerifyHeader
  PythonRequestsLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      CompatibleRuntimes:
      - python3.7
      ContentUri: ../../src/python-requests-lambda-layer.zip
      Description: Python requests module and deps
      LayerName:
        Fn::Join:
        - '-'
        - - Ref: AWS::StackName
          - python-requests
  OriginSecretRotateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description: Serets Manager Rotation Lambda
      Handler: lambda_function.lambda_handler
      Runtime: python3.7
      Layers:
      - Ref: PythonRequestsLayer
      Environment:
        Variables:
          WAFACLID:
            Fn::GetAtt:
            - wafACLR
            - Id
          WAFACLNAME:
            Fn::Select:
            - 0
            - Fn::Split:
              - '|'
              - Ref: wafACLR
          WAFRULEPRI:
            Ref: WAFRulePriority
          CFDISTROID:
            Ref: CloudFrontDistribution
          HEADERNAME:
            Ref: HeaderName
          ORIGINURL:
            Ref: ApiGatewayURL
          STACKNAME:
            Ref: AWS::StackName
          AWSREGION:
            Ref: AWS::Region
      Role:
        Fn::GetAtt:
        - OriginSecretRotateExecutionRole
        - Arn
      Timeout: 60
      CodeUri: ../../src/python-requests-lambda-layer.zip
  OriginSecretRotateExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: OriginVerifyRotatePolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            - logs:DescribeLogStreams
            Resource:
              Fn::Sub: arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*OriginSecretRotateFunction*
          - Effect: Allow
            Action:
            - secretsmanager:DescribeSecret
            - secretsmanager:GetSecretValue
            - secretsmanager:PutSecretValue
            - secretsmanager:UpdateSecretVersionStage
            Resource:
              Ref: OriginVerifyHeader
          - Effect: Allow
            Action:
            - secretsmanager:GetRandomPassword
            Resource: '*'
          - Effect: Allow
            Action:
            - cloudfront:GetDistribution
            - cloudfront:GetDistributionConfig
            - cloudfront:ListDistributions
            - cloudfront:UpdateDistribution
            Resource:
              Fn::Sub: arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}
          - Effect: Allow
            Action:
            - wafv2:*
            Resource:
              Fn::GetAtt:
              - wafACLR
              - Arn
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
  wafACLR:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name:
        Fn::Sub: ${AWS::StackName}-ACLR
      Scope: REGIONAL
      DefaultAction:
        Block: {}
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName:
          Fn::Sub: ${AWS::StackName}-ACLMetricR
      Rules:
      - Name:
          Fn::Sub: ${AWS::StackName}-XRule
        Priority:
          Ref: WAFRulePriority
        Action:
          Allow: {}
        VisibilityConfig:
          SampledRequestsEnabled: true
          CloudWatchMetricsEnabled: true
          MetricName:
            Fn::Sub: ${AWS::StackName}-XMetric
        Statement:
          OrStatement:
            Statements:
            - ByteMatchStatement:
                FieldToMatch:
                  SingleHeader:
                    Name:
                      Ref: HeaderName
                PositionalConstraint: EXACTLY
                SearchString:
                  Fn::Join:
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - Ref: OriginVerifyHeader
                    - :SecretString:HEADERVALUE}}
                TextTransformations:
                - Priority: 0
                  Type: NONE
            - ByteMatchStatement:
                FieldToMatch:
                  SingleHeader:
                    Name:
                      Ref: HeaderName
                PositionalConstraint: EXACTLY
                SearchString:
                  Fn::Join:
                  - ''
                  - - '{{resolve:secretsmanager:'
                    - Ref: OriginVerifyHeader
                    - :SecretString:HEADERVALUE}}
                TextTransformations:
                - Priority: 0
                  Type: NONE
  wafACLG:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name:
        Fn::Sub: ${AWS::StackName}-ACLG
      Scope: CLOUDFRONT
      DefaultAction:
        Allow: {}
      VisibilityConfig:
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName:
          Fn::Sub: ${AWS::StackName}-ACLMetricG
  wafAPIGWAssociation:
    DependsOn: wafACLR
    Type: AWS::WAFv2::WebACLAssociation
    Properties:
      ResourceArn:
        Fn::Sub:
        - arn:aws:apigateway:${AWS::Region}::/restapis/${rest_api_id}/stages/${stage_name}
        - rest_api_id:
            Fn::Select:
            - 0
            - Fn::Split:
              - .
              - Fn::Select:
                - 2
                - Fn::Split:
                  - /
                  - Ref: ApiGatewayURL
          stage_name:
            Fn::Select:
            - 3
            - Fn::Split:
              - /
              - Ref: ApiGatewayURL
      WebACLArn:
        Fn::GetAtt:
        - wafACLR
        - Arn
Outputs:
  CognitoUserPoolID:
    Value:
      Ref: WAUserPool
    Description: User Pool ID
  CognitoAppClientID:
    Value:
      Ref: WAUserPoolClient
    Description: App Client ID
  CognitoSignupURL:
    Description: Firstly, please do sign up for API Authorization
    Value:
      Fn::Join:
      - ''
      - - https://
        - walab-
        - Fn::Select:
          - 2
          - Fn::Split:
            - /
            - Ref: AWS::StackId
        - Fn::Sub: .auth.${AWS::Region}.amazoncognito.com/login?client_id=
        - Ref: WAUserPoolClient
        - '&response_type=code&scope=aws.cognito.signin.user.admin+email+openid&redirect_uri=https://example.com/callback'
  CloudFrontConsole:
    Description: CloudFront console
    Value:
      Fn::Sub: https://console.aws.amazon.com/cloudfront/home?region=${AWS::Region}#
  CloudFrontEndpoint:
    Description: Use this endpoint instead of API Gateway endpoint
    Value:
      Fn::Join:
      - ''
      - - https://
        - Fn::GetAtt:
          - CloudFrontDistribution
          - DomainName
        - /?id=1
  OriginVerifyHeaderName:
    Description: Origin Header Name in CloudFront
    Value:
      Ref: HeaderName
  OriginVerifyHeader:
    Description: Origin Header for Origin Validation
    Value:
      Fn::Sub: https://console.aws.amazon.com/secretsmanager/home?region=${AWS::Region}#/secret?name=${OriginVerifyHeader}
  WAFWebACLR:
    Description: Regional WAF Web ACL associated with test website
    Value:
      Fn::Join:
      - ''
      - - https://console.aws.amazon.com/wafv2/homev2/web-acl/
        - Fn::Select:
          - 0
          - Fn::Split:
            - '|'
            - Ref: wafACLR
        - /
        - Fn::GetAtt:
          - wafACLR
          - Id
        - /overview?region=
        - Fn::Sub: ${AWS::Region}
  WAFWebACLG:
    Description: Global WAF Web ACL associated with test website
    Value:
      Fn::Join:
      - ''
      - - https://console.aws.amazon.com/wafv2/homev2/web-acl/
        - Fn::Select:
          - 0
          - Fn::Split:
            - '|'
            - Ref: wafACLG
        - /
        - Fn::GetAtt:
          - wafACLG
          - Id
        - /overview?region=global
