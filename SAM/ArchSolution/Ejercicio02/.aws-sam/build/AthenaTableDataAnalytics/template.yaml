AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Athena resources for data analytics
Parameters:
  StreamBucketName:
    Type: String
    Description: S3 bucket name
    AllowedPattern: .+
Resources:
  WorkGroupClickstream:
    Type: AWS::Athena::WorkGroup
    Properties:
      Name:
        Fn::Sub: ${AWS::StackName}-clickstream
      Description: Workgroup for clickstream data
      RecursiveDeleteOption: true
      WorkGroupConfiguration:
        PublishCloudWatchMetricsEnabled: true
        ResultConfiguration:
          OutputLocation:
            Fn::Sub: s3://${StreamBucketName}/athena/results
  ClickstreamViews:
    Type: AWS::Athena::NamedQuery
    Properties:
      Database: default
      Description: Create table for clickstream data
      Name: clickstream_views
      QueryString: 'CREATE EXTERNAL TABLE my_ingested_data (

        element_clicked STRING,

        time_spent INT,

        source_menu STRING,

        created_at STRING)

        PARTITIONED BY (datehour STRING

        ROW FORMAT SERDE ''org.openx.data.jsonserde.JsonSerDe''

        with serdeproperties ( ''paths''=''element_clicked, time_spent, source_menu,
        created_at'' )

        LOCATION ''s3://<<StreamBucketName>>/''

        TBLPROPERTIES (

        "projection.enabled" = "true",

        "projection.datehour.type" = "date",

        "projection.datehour.format" = "yyyy/MM/dd/HH",

        "projection.datehour.range" = "2021/01/01/00,NOW",

        "projection.datehour.interval" = "1",

        "projection.datehour.interval.unit" = "HOURS",

        "storage.location.template" = "s3://<<StreamBucketName>>/${datehour}/");

        '
  QryTest:
    Type: AWS::Athena::NamedQuery
    Properties:
      Database: default
      Description: Test query
      Name: test_query
      QueryString: SELECT * FROM my_ingested_data;
