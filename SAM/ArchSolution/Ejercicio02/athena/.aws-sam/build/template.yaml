AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Athena resources for data analytics
Parameters:
  StreamBucketName:
    Type: String
    Description: S3 bucket name
Resources:
  CreateTableFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${AWS::StackName}-CreateAthenaTable
      Description: Create Athena table for data analytics
      CodeUri: CreateTableFunction
      Handler: create_table.lambda_handler
      Runtime: python3.9
      Timeout: 120
      MemorySize: 128
      Environment:
        Variables:
          STREAM_BUCKET_NAME:
            Ref: StreamBucketName
      Policies:
      - S3ReadPolicy:
          BucketName:
            Ref: StreamBucketName
      - S3CrudPolicy:
          BucketName:
            Ref: StreamBucketName
      - AthenaQueryPolicy:
          WorkGroupName: clickstream
    Metadata:
      SamResourceId: CreateTableFunction
  WorkGroupClickstream:
    Type: AWS::Athena::WorkGroup
    Properties:
      Name: clickstream
      Description: Workgroup for clickstream data
      RecursiveDeleteOption: true
      WorkGroupConfiguration:
        PublishCloudWatchMetricsEnabled: true
        ResultConfiguration:
          OutputLocation:
            Fn::Sub: s3://${StreamBucketName}/athena/results
  QryTest:
    Type: AWS::Athena::NamedQuery
    Properties:
      Database: default
      Description: Test query
      Name: test_query
      QueryString: SELECT * FROM my_ingested_data;
