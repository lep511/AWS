AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Sample Slack Template
Parameters:
  SlackURL:
    Type: String
    Description: Incoming Webhook unique URL
Resources:
  SlackFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: SlackFunctionRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      - arn:aws:iam::aws:policy/CloudWatchLogsFullAccess
  SlackFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SlackFunction
      Handler: lambda_function.lambda_handler
      Runtime: python3.9
      MemorySize: 128
      Role:
        Fn::GetAtt:
        - SlackFunctionRole
        - Arn
      Timeout: 90
      Environment:
        Variables:
          SLACK_URL:
            Ref: SlackURL
      Events:
        SlackEvent:
          Type: EventBridgeRule
          Properties:
            Pattern:
              source:
              - aws.config
              detail-type:
              - Config Rules Compliance Change
              detail:
                configRuleName:
                - SlackSample
                newEvaluationResult:
                  complianceType:
                  - NON_COMPLIANT
    Metadata:
      SamResourceId: SlackFunction
  Libs:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: slack-layer
      Description: Lambda layer with slack library
      ContentUri: ../../libs
      CompatibleRuntimes:
      - python3.9
